<!DOCTYPE html>
<html lang="th">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบรายงานสาธารณูปโภค</title>
    
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for statistics visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts for better typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Apply custom font to the body */
        body {
            font-family: 'Sarabun', sans-serif;
        }
        /* Custom animation for fade-in effect */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        /* Custom style for active tab */
        .tab-link.active {
            border-color: #facc15; /* yellow-400 */
            background-color: #b91c1c; /* red-700 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header Section -->
    <header class="bg-red-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4 flex flex-col items-center text-center">
            <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Seal_of_Ko_Samui.png" alt="ตราสัญลักษณ์เทศบาลนครเกาะสมุย" class="h-24 w-24 mb-2 object-contain">
            <h1 class="text-2xl md:text-3xl font-bold">ระบบรายงานสาธารณูปโภค</h1>
        </div>
        <!-- Tab Navigation -->
        <nav class="bg-red-800">
            <div class="container mx-auto flex justify-center">
                <button class="tab-link active text-white font-semibold py-3 px-6 border-b-4 border-transparent transition duration-300 ease-in-out" onclick="app.openTab(event, 'report')">
                    รายงานผลประจำเดือน
                </button>
                <button class="tab-link text-white font-semibold py-3 px-6 border-b-4 border-transparent transition duration-300 ease-in-out" onclick="app.openTab(event, 'stats')">
                    สถิติ
                </button>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 md:p-6">
        <!-- Report Submission Tab -->
        <div id="report" class="tab-content active fade-in">
            <div class="max-w-2xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-md">
                <form id="utilityForm">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
                        <!-- Month Selector -->
                        <div class="form-group">
                            <label for="reportMonth" class="block text-sm font-medium text-gray-700 mb-1">เดือน</label>
                            <select id="reportMonth" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500"></select>
                        </div>
                        <!-- Year Selector -->
                        <div class="form-group">
                            <label for="reportYear" class="block text-sm font-medium text-gray-700 mb-1">ปี (พ.ศ.)</label>
                            <select id="reportYear" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500"></select>
                        </div>
                    </div>
                    <!-- Building Selector -->
                    <div class="form-group mb-6">
                        <label for="building" class="block text-sm font-medium text-gray-700 mb-1">อาคาร</label>
                        <select id="building" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500">
                            <option value="" disabled selected>-- เลือกอาคาร --</option>
                            <option value="โรงปรับปรุงคุณภาพน้ำหน้าทอน">โรงปรับปรุงคุณภาพน้ำหน้าทอน</option>
                            <option value="โรงปรับปรุงคุณภาพน้ำละไม">โรงปรับปรุงคุณภาพน้ำละไม</option>
                            <option value="โรงปรับปรุงคุณภาพน้ำเฉวง">โรงปรับปรุงคุณภาพน้ำเฉวง</option>
                            <option value="ระบบบำบัดน้ำเสียแม่น้ำ">ระบบบำบัดน้ำเสียแม่น้ำ</option>
                            <option value="ระบบบำบัดน้ำเสียหลังสภ.บ่อผุด">ระบบบำบัดน้ำเสียหลังสภ.บ่อผุด</option>
                            <option value="ระบบบำบัดน้ำเสียเขาหัวจุก">ระบบบำบัดน้ำเสียเขาหัวจุก</option>
                            <option value="ระบบบำบัดน้ำเสียร้านทองสุข">ระบบบำบัดน้ำเสียร้านทองสุข</option>
                            <option value="ระบบบำบัดน้ำเสียหลังวัดสว่าง">ระบบบำบัดน้ำเสียหลังวัดสว่าง</option>
                            <option value="ระบบบำบัดน้ำเสียเหนือคลอง">ระบบบำบัดน้ำเสียเหนือคลอง</option>
                            <option value="โรงสูบน้ำแยกสาม">โรงสูบน้ำแยกสาม</option>
                        </select>
                    </div>
                    <!-- Utility Costs Inputs -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-4">
                        <div class="form-group">
                            <label for="water" class="block text-sm font-medium text-gray-700 mb-1">ค่าน้ำ (บาท)</label>
                            <input type="number" id="water" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="electricity" class="block text-sm font-medium text-gray-700 mb-1">ค่าไฟฟ้า (บาท)</label>
                            <input type="number" id="electricity" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">ค่าโทรศัพท์ (บาท)</label>
                            <input type="number" id="phone" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="internet" class="block text-sm font-medium text-gray-700 mb-1">ค่าอินเตอร์เน็ต (บาท)</label>
                            <input type="number" id="internet" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="fuel" class="block text-sm font-medium text-gray-700 mb-1">ค่าน้ำมันเชื้อเพลิง (บาท)</label>
                            <input type="number" id="fuel" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="recorderName" class="block text-sm font-medium text-gray-700 mb-1">ผู้บันทึกข้อมูล</label>
                            <input type="text" id="recorderName" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500" placeholder="ชื่อ-สกุล">
                        </div>
                    </div>
                     <!-- Notes Textarea -->
                    <div class="form-group mb-6">
                        <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ</label>
                        <textarea id="notes" rows="3" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500" placeholder="รายละเอียดเพิ่มเติม (ถ้ามี)"></textarea>
                    </div>
                    <!-- Submit Button -->
                    <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        บันทึกข้อมูล
                    </button>
                    <!-- Status Message Area -->
                    <div id="status" class="mt-4 text-center font-medium h-6"></div>
                </form>
            </div>
        </div>

        <!-- Statistics Tab -->
        <div id="stats" class="tab-content hidden fade-in">
            <div class="max-w-6xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-md">
                <!-- Date Range Filter -->
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 items-end mb-6 bg-gray-50 p-4 rounded-lg">
                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">เดือนเริ่มต้น</label>
                        <select id="startMonth" class="w-full p-2 border border-gray-300 rounded-md"></select>
                    </div>
                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ปีเริ่มต้น</label>
                        <select id="startYear" class="w-full p-2 border border-gray-300 rounded-md"></select>
                    </div>
                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">เดือนสิ้นสุด</label>
                        <select id="endMonth" class="w-full p-2 border border-gray-300 rounded-md"></select>
                    </div>
                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ปีสิ้นสุด</label>
                        <select id="endYear" class="w-full p-2 border border-gray-300 rounded-md"></select>
                    </div>
                    <div class="col-span-2 md:col-span-1">
                        <button onclick="app.filterAndRenderChart()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                            ดูสถิติ
                        </button>
                    </div>
                </div>
                <!-- Chart Container -->
                <div id="chart-container" class="relative min-h-[400px]">
                    <canvas id="utilityChart"></canvas>
                    <div id="chart-message" class="absolute inset-0 flex items-center justify-center text-gray-500 text-lg font-semibold hidden"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer Section -->
    <footer class="text-center py-6 text-gray-500 text-sm">
        <p>©2025 ระบบรายงานสาธารณูปโภคกองช่างสุขาภิบาล</p>
        <p>โดยนายธีรศักดิ์ พูลเขาล้าน</p>
    </footer>

    <script>
        // Encapsulate the application logic in an 'app' object
        const app = {
            utilityChart: null,
            allData: [],
            THAI_MONTHS_FULL: [
                "มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน",
                "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"
            ],

            // Initializes the application
            init() {
                this.populateDateSelectors();
                this.setupEventListeners();
                this.loadChartData(); // Load initial data for the chart tab
            },

            // Sets up all event listeners
            setupEventListeners() {
                document.getElementById("utilityForm").addEventListener("submit", (e) => {
                    e.preventDefault();
                    this.submitForm();
                });
            },

            // Populates all month and year dropdowns
            populateDateSelectors() {
                const monthSelectIds = ["reportMonth", "startMonth", "endMonth"];
                const yearSelectIds = ["reportYear", "startYear", "endYear"];
                const currentBuddhistYear = new Date().getFullYear() + 543;
                const years = Array.from({ length: 10 }, (_, i) => currentBuddhistYear - 5 + i); // Range of 10 years

                monthSelectIds.forEach(id => {
                    const select = document.getElementById(id);
                    select.innerHTML = "";
                    this.THAI_MONTHS_FULL.forEach(month => select.add(new Option(month, month)));
                });

                yearSelectIds.forEach(id => {
                    const select = document.getElementById(id);
                    select.innerHTML = "";
                    years.forEach(year => select.add(new Option(year, year)));
                });
                
                // Set default values for the report form
                const now = new Date();
                document.getElementById("reportMonth").value = this.THAI_MONTHS_FULL[now.getMonth()];
                document.getElementById("reportYear").value = currentBuddhistYear;
            },

            // Handles tab switching
            openTab(evt, tabName) {
                document.querySelectorAll(".tab-content").forEach(tc => tc.classList.add("hidden"));
                document.querySelectorAll(".tab-link").forEach(tl => tl.classList.remove("active"));
                
                document.getElementById(tabName).classList.remove("hidden");
                evt.currentTarget.classList.add("active");

                if (tabName === "stats") {
                    // Always try to render chart when tab is opened
                    this.filterAndRenderChart();
                }
            },

            // Handles form submission
            submitForm() {
                const data = {
                    reportMonth: document.getElementById("reportMonth").value,
                    reportYear: document.getElementById("reportYear").value,
                    building: document.getElementById("building").value,
                    water: document.getElementById("water").value,
                    electricity: document.getElementById("electricity").value,
                    phone: document.getElementById("phone").value,
                    internet: document.getElementById("internet").value,
                    fuel: document.getElementById("fuel").value,
                    notes: document.getElementById("notes").value,
                    recorderName: document.getElementById("recorderName").value,
                };

                if (!data.building) {
                    this.showStatus("กรุณาเลือกอาคาร", "error");
                    return;
                }

                if (typeof google !== 'undefined' && google.script && google.script.run) {
                    this.showStatus("⏳ กำลังบันทึกข้อมูล...", "loading");
                    
                    google.script.run
                        .withSuccessHandler(msg => {
                            this.showStatus(`✅ ${msg}`, "success");
                            document.getElementById("utilityForm").reset();
                            this.populateDateSelectors();
                            this.loadChartData(); // Refresh chart data after submission
                        })
                        .withFailureHandler(err => {
                            this.showStatus(`❌ เกิดข้อผิดพลาด: ${err.message}`, "error");
                        })
                        .saveData(data);
                } else {
                    this.showStatus("❌ ไม่สามารถบันทึกได้ (ทดสอบนอกสภาพแวดล้อม Google)", "error");
                    console.warn("google.script.run is not available.");
                }
            },

            // Displays status messages
            showStatus(message, type) {
                const statusDiv = document.getElementById("status");
                statusDiv.textContent = message;
                statusDiv.className = "mt-4 text-center font-medium h-6"; // Reset classes
                if (type === 'success') statusDiv.classList.add('text-green-600');
                if (type === 'error') statusDiv.classList.add('text-red-600');
                if (type === 'loading') statusDiv.classList.add('text-blue-600');
                
                if(type === 'success' || type === 'error') {
                    setTimeout(() => statusDiv.textContent = '', 5000);
                }
            },

            showChartMessage(message) {
                const msgDiv = document.getElementById("chart-message");
                const chartCanvas = document.getElementById("utilityChart");
                msgDiv.textContent = message;
                msgDiv.classList.remove('hidden');
                chartCanvas.classList.add('hidden');
            },

            hideChartMessage() {
                 const msgDiv = document.getElementById("chart-message");
                 const chartCanvas = document.getElementById("utilityChart");
                 msgDiv.classList.add('hidden');
                 chartCanvas.classList.remove('hidden');
            },

            // Loads data for the chart from Google Apps Script
            loadChartData() {
                console.log("1. Starting loadChartData..."); // DEBUG
                if (typeof google !== 'undefined' && google.script && google.script.run) {
                    this.showChartMessage("กำลังโหลดข้อมูลสถิติ...");
                    google.script.run
                        .withSuccessHandler(data => {
                            console.log("2. Data received from Google Sheet:", data); // DEBUG
                            if (data && Array.isArray(data)) {
                                this.allData = data;
                                this.setDefaultDateRange();
                                this.filterAndRenderChart();
                            } else {
                                console.error("Data received is not a valid array:", data);
                                this.showChartMessage("รูปแบบข้อมูลที่ได้รับไม่ถูกต้อง");
                            }
                        })
                        .withFailureHandler(err => {
                            console.error("3. Failed to load data from Google Sheet:", err); // DEBUG
                            this.showChartMessage(`ไม่สามารถโหลดข้อมูลได้: ${err.message}`);
                        })
                        .getSheetData();
                } else {
                    this.showChartMessage("ไม่สามารถโหลดข้อมูลได้ (ทดสอบนอกสภาพแวดล้อม Google)");
                    console.warn("google.script.run is not available.");
                }
            },
            
            setDefaultDateRange() {
                const now = new Date();
                const endDate = new Date(now.getFullYear(), now.getMonth(), 1);
                // Correctly calculate 11 months before the current month
                const startDate = new Date(now.getFullYear(), now.getMonth() - 11, 1);

                document.getElementById("endMonth").value = this.THAI_MONTHS_FULL[endDate.getMonth()];
                document.getElementById("endYear").value = endDate.getFullYear() + 543;
                document.getElementById("startMonth").value = this.THAI_MONTHS_FULL[startDate.getMonth()];
                document.getElementById("startYear").value = startDate.getFullYear() + 543;
                console.log(`4. Default date range set: ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`); // DEBUG
            },

            // Filters data based on selected date range and triggers chart rendering
            filterAndRenderChart() {
                console.log("5. Starting filterAndRenderChart..."); // DEBUG
                if (!this.allData || this.allData.length === 0) {
                    console.log("No data available to filter."); // DEBUG
                    this.showChartMessage("ยังไม่มีข้อมูลในระบบ");
                    return;
                }

                const startMonth = document.getElementById("startMonth").value;
                const startYear = parseInt(document.getElementById("startYear").value, 10);
                const endMonth = document.getElementById("endMonth").value;
                const endYear = parseInt(document.getElementById("endYear").value, 10);

                const fromDate = new Date(startYear - 543, this.THAI_MONTHS_FULL.indexOf(startMonth), 1);
                const toDate = new Date(endYear - 543, this.THAI_MONTHS_FULL.indexOf(endMonth) + 1, 0);
                
                console.log(`6. Filtering data from ${fromDate.toISOString()} to ${toDate.toISOString()}`); // DEBUG

                const filteredData = this.allData.filter(row => {
                    const recordMonthIndex = this.THAI_MONTHS_FULL.indexOf(row[1]);
                    const recordYear = parseInt(row[2], 10) - 543;
                    if (recordMonthIndex === -1 || isNaN(recordYear)) {
                        return false;
                    }
                    
                    const recordDate = new Date(recordYear, recordMonthIndex, 1);
                    return recordDate >= fromDate && recordDate <= toDate;
                });
                
                console.log("7. Filtered data result:", filteredData); // DEBUG
                this.renderChart(filteredData);
            },

            // Renders the chart with the provided data
            renderChart(data) {
                console.log("8. Starting renderChart with data:", data); // DEBUG
                if (!data || data.length === 0) {
                    this.showChartMessage("ไม่พบข้อมูลตามช่วงเวลาที่เลือก");
                    if (this.utilityChart) {
                        this.utilityChart.destroy();
                        this.utilityChart = null;
                    }
                    return;
                }
                
                this.hideChartMessage();

                const grouped = data.reduce((acc, row) => {
                    const key = `${row[1]} ${row[2]}`;
                    if (!acc[key]) {
                        acc[key] = { water: 0, electricity: 0, phone: 0, internet: 0, fuel: 0, date: new Date(parseInt(row[2])-543, this.THAI_MONTHS_FULL.indexOf(row[1])) };
                    }
                    acc[key].water += Number(row[4] || 0);
                    acc[key].electricity += Number(row[5] || 0);
                    acc[key].phone += Number(row[6] || 0);
                    acc[key].internet += Number(row[7] || 0);
                    acc[key].fuel += Number(row[8] || 0);
                    return acc;
                }, {});
                
                console.log("9. Grouped data for chart:", grouped); // DEBUG

                const sortedLabels = Object.keys(grouped).sort((a, b) => grouped[a].date - grouped[b].date);
                console.log("10. Sorted labels for chart:", sortedLabels); // DEBUG

                const datasets = [
                    { label: "ค่าน้ำ", data: sortedLabels.map(l => grouped[l].water), backgroundColor: 'rgba(54, 162, 235, 0.5)', borderColor: 'rgb(54, 162, 235)' },
                    { label: "ค่าไฟฟ้า", data: sortedLabels.map(l => grouped[l].electricity), backgroundColor: 'rgba(255, 206, 86, 0.5)', borderColor: 'rgb(255, 206, 86)' },
                    { label: "ค่าโทรศัพท์", data: sortedLabels.map(l => grouped[l].phone), backgroundColor: 'rgba(75, 192, 192, 0.5)', borderColor: 'rgb(75, 192, 192)' },
                    { label: "ค่าอินเตอร์เน็ต", data: sortedLabels.map(l => grouped[l].internet), backgroundColor: 'rgba(153, 102, 255, 0.5)', borderColor: 'rgb(153, 102, 255)' },
                    { label: "ค่าน้ำมัน", data: sortedLabels.map(l => grouped[l].fuel), backgroundColor: 'rgba(255, 99, 132, 0.5)', borderColor: 'rgb(255, 99, 132)' }
                ];
                
                datasets.forEach(ds => {
                    ds.borderWidth = 2;
                    ds.hoverBorderWidth = 3;
                });

                if (this.utilityChart) {
                    this.utilityChart.destroy();
                }

                const ctx = document.getElementById("utilityChart").getContext("2d");
                this.utilityChart = new Chart(ctx, {
                    type: "bar",
                    data: { labels: sortedLabels, datasets: datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: "สรุปค่าใช้จ่ายสาธารณูปโภครายเดือน", font: { size: 18, family: "'Sarabun', sans-serif" } },
                            legend: { position: 'top', labels: { font: { family: "'Sarabun', sans-serif" } } },
                             tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: "ค่าใช้จ่าย (บาท)", font: { size: 14, family: "'Sarabun', sans-serif" } },
                                ticks: {
                                    callback: function(value) {
                                        return new Intl.NumberFormat('th-TH').format(value);
                                    }
                                }
                            },
                            x: {
                                ticks: { font: { family: "'Sarabun', sans-serif" } }
                            }
                        }
                    }
                });
                console.log("11. Chart rendered successfully."); // DEBUG
            }
        };

        document.addEventListener("DOMContentLoaded", () => {
            app.init();
        });
    </script>
</body>
</html>
